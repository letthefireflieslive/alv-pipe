---
- name: Install istio tools
  hosts: vagrantbox
  become: yes
  tags:
    - istio

  vars_files:
    - ../vars.yml

  vars:
    - istio_namespace: istio-system
    - istio_ingress_namespace: istio-ingress

  roles:
    - { role: andrewrothstein.kubernetes-helm, kubernetes_helm_ver: v3.7.2 }

  tasks:
    - name: Configure Helm Repo
      command: "{{ bin_dir }}/helm repo add istio https://istio-release.storage.googleapis.com/charts"

    - name: Helm Repo Update
      command: "{{ bin_dir }}/helm repo update"

    - name: Create istio namespace
      command: "{{ bin_dir }}/kubectl --kubeconfig {{ kube_config }} create namespace {{ istio_namespace }}"
      ignore_errors: yes

    - name: Install istio base chart
      command: "{{ bin_dir }}/helm --kubeconfig {{ kube_config }} install istio-base istio/base -n {{ istio_namespace }}"
      ignore_errors: yes

    - name: Helm install istiod
      command: "{{ bin_dir }}/helm --kubeconfig {{ kube_config }} install istiod istio/istiod -n {{ istio_namespace }} --wait"
      ignore_errors: yes

    - name: Create istio ingressgateway namespace
      command: "{{ bin_dir }}/kubectl --kubeconfig {{ kube_config }} create namespace {{ istio_ingress_namespace }}"
      ignore_errors: yes

    - name: Istio inject ingress gateway namespace
      command: "{{ bin_dir }}/kubectl --kubeconfig {{ kube_config }} label namespace {{ istio_ingress_namespace }} istio-injection=enabled"
      ignore_errors: yes

    - name: Helm install ingress gateway
      command: "{{ bin_dir }}/helm --kubeconfig {{ kube_config }} install {{ istio_ingress_namespace }} istio/gateway -n {{ istio_ingress_namespace }} --wait"
      ignore_errors: yes
